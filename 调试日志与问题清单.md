# 调试日志与问题清单（供大模型参考）

**项目：多设备同步待办事项**  
**生成日期：** 2026-02-19  
**目的：帮助大模型理解开发过程中的常见问题与解决方案，支持 vibe coding**

---

## 一、本次开发问题汇总

### 问题 1：Docker Desktop 无法启动（WSL 版本过旧）

**现象：** Docker Desktop 提示 "WSL needs updating"  
**原因：** Windows Subsystem for Linux 版本不满足 Docker Desktop 要求  
**解决：** 执行 `wsl --update` 更新 WSL，然后重启 Docker Desktop  
**命令：**
```powershell
wsl --update
# 重启 Docker Desktop 后验证
docker --version
docker compose version
```

---

### 问题 2：Prisma 版本不兼容（v7 配置变更）

**现象：** `npx prisma generate` 报错  
```
The datasource property `url` is no longer supported in schema files.
```
**原因：** Prisma v7 要求使用 `prisma.config.ts` 配置数据源，与当前 schema 不兼容  
**解决：** 降级到 Prisma v5  
```powershell
npm install prisma@5 @prisma/client@5 --save
npx prisma generate
npx prisma migrate dev --name init
```

---

### 问题 3：后端 CORS 未包含前端端口

**现象：** 前端请求被浏览器拦截，报 CORS 错误  
**原因：** 后端 `main.ts` 中 CORS 配置只允许 `http://localhost:5173`，但如果前端端口变化会失败  
**解决：** 确认 CORS 配置与前端端口一致  
```typescript
// todo-api/src/main.ts
app.enableCors({
  origin: ['http://localhost:5173'], // 与前端端口一致
  credentials: true,
});
```

---

### 问题 4：前端 API 响应格式兼容问题

**现象：** 登录请求返回 `{ data: undefined }`，前端无法获取 token  
**原因：** 后端 Auth 模块直接返回业务对象（如 `{ access_token, userId, email }`），未包装 `{ data }`  
**解决：** 前端 `api.ts` 兼容两种格式  
```typescript
// todo-web/src/utils/api.ts
return { data: data.data !== undefined ? data.data : data };
```

---

### 问题 5：ValidationPipe 可选字段验证报错

**现象：** 注册时返回 400 错误 `["name must be a string"]`  
**原因：** `RegisterDto` 中 `name` 字段缺少 `@IsOptional()` 装饰器  
**解决：** 添加 `@IsOptional()` 并在 `main.ts` 中启用 `enableImplicitConversion`  
```typescript
// todo-api/src/modules/auth/auth.dto.ts
@IsOptional()
@IsString()
name?: string;

// todo-api/src/main.ts
app.useGlobalPipes(new ValidationPipe({
  whitelist: true,
  transform: true,
  transformOptions: { enableImplicitConversion: true },
}));
```

---

### 问题 6：Windows PowerShell curl 命令冲突

**现象：** 执行 `curl` 时弹出交互式输入提示  
**原因：** PowerShell 的 `curl` 是 `Invoke-WebRequest` 的别名，与 Unix curl 不兼容  
**解决：** 使用完整路径或 PowerShell 原生命令  
```powershell
# 方案1：使用完整路径
& "C:\Windows\System32\curl.exe" http://localhost:3000/

# 方案2：使用 PowerShell 原生命令
Invoke-WebRequest -Uri "http://localhost:3000/" -UseBasicParsing

# 方案3：写入 .ps1 脚本执行
```

---

### 问题 7：前端热更新后请求无响应

**现象：** 前端 Vite 热更新后，点击登录按钮无任何反应  
**原因：** 后端服务可能因代码变更重启失败或端口丢失  
**解决：** 重启后端服务  
```powershell
# 在 todo-api 目录
npm run start:dev
```

---

### 问题 8：M3 增量同步接口实现

**现象：** 需要实现多设备同步功能  
**原因：** M2 只有基础 CRUD，没有同步机制  
**解决：** 实现增量同步接口  
```typescript
// 后端 todos.controller.ts
@Get('sync')
async sync(@Query('since') since?: string) {
  const sinceDate = since ? new Date(since) : new Date(0);
  return this.todos.getChanges(req.user.userId, sinceDate);
}

// 后端 todos.service.ts
async getChanges(userId: string, since: Date): Promise<TodoChange[]> {
  // 返回自 since 之后的变更，包含 _action: 'create' | 'update' | 'delete'
}
```

---

### 问题 9：前端同步状态与触发时机

**现象：** 需要在多个时机触发同步  
**原因：** 多设备同步需要及时拉取最新数据  
**解决：** 在启动、登录、网络恢复时触发同步  
```typescript
// 前端 App.tsx
// 启动时
useEffect(() => { if (token) syncTodos(); }, []);

// 网络恢复时
window.addEventListener('online', () => { syncTodos(); });

// 登录后
handleLogin() { syncTodos(); }
```

---

### 问题 10：软删除与删除不复活

**现象：** 删除的待办在离线设备上可能会"复活"  
**原因：** 硬删除会导致同步时重新拉取  
**解决：** 使用软删除（deletedAt 字段）  
```typescript
// 后端 todos.service.ts
async delete(userId: string, id: string) {
  await this.prisma.todo.update({
    where: { id },
    data: { deletedAt: new Date() },  // 软删除
  });
}

// 查询时过滤已删除
where: { userId, deletedAt: null }
```

---

## 问题 11：Android/Expo Web 预览 CORS 问题

**现象：** 登录请求被 CORS 阻止
```
Access to XMLHttpRequest at 'http://localhost:3000/auth/login' 
from origin 'http://localhost:8083' has been blocked by CORS policy
```
**原因：** 后端 CORS 只配置了 `http://localhost:5173`，Expo Web 预览用 8083 端口
**解决：** 在后端 CORS 配置中添加所有可能的前端端口
```typescript
// todo-api/src/main.ts
app.enableCors({
  origin: ['http://localhost:5173', 'http://localhost:8083'],
  credentials: true,
});
```

---

## 问题 12：Android 模拟器访问 localhost

**现象：** Android 模拟器无法访问 `http://localhost:3000`
**原因：** 模拟器中 localhost 指向模拟器本身，不是宿主机
**解决：** 使用特殊 IP `10.0.2.2` 访问宿主机
```typescript
// todo-mobile/src/services/api.ts
const API_URL = 'http://10.0.2.2:3000'; // Android 模拟器
// Web 预览用 localhost
const API_URL = 'http://localhost:3000';
```

---

## 问题 13：后端响应格式不一致

**现象：** 后端 Auth 模块直接返回 `{ access_token }`，未包装 `{ data }`
**原因：** 成功响应未使用全局异常过滤器的包装格式
**解决：** 前端兼容两种格式
```typescript
// todo-mobile/src/screens/LoginScreen.tsx
const token = res.data?.access_token || res.access_token;
```

---

## 问题 14：Expo Web 预览需要额外依赖

**现象：** `npx expo start --web` 报错需要安装 react-dom
**解决：** 运行 `npx expo install react-dom react-native-web`

---

## 问题 15：邮箱验证码找回密码

**现象：** 用户忘记密码需要重置
**解决：** 后端添加邮箱验证码接口
```typescript
// todo-api/src/modules/auth/auth.controller.ts
@Post('send-code')  // 发送验证码
@Post('reset-password')  // 重置密码
```

**环境变量（邮箱发送）：**
```env
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-app-password
```

---

## 问题 16：GitHub Actions 构建 Android APK 失败 - todo-mobile 是 Git Submodule

**现象：**
```
npm error path /home/runner/work/20260220TodoAPK/20260220TodoAPK/todo-mobile/package.json
npm error enoent Could not read package.json
fatal: No url found for submodule path 'todo-mobile' in .gitmodules
```
**原因：** `todo-mobile` 在仓库里是 Git submodule 指针（mode 160000），Actions checkout 时只拉取引用，不包含实际文件
**解决：**
```bash
# 1. 删除本地的 .git 目录（如果是 submodule）
rm -rf todo-mobile/.git

# 2. 重新 add 并 commit 为普通目录
git add todo-mobile
git commit -m "Fix: merge todo-mobile into main repo"
git push origin main
```

---

## 问题 17：Vercel 部署 Web 前端 404

**现象：** 访问 `https://20260220-todo-apk.vercel.app` 显示 404
**原因：** 仓库是 monorepo（包含 todo-api/、todo-mobile/、todo-web/），Vercel 没指定 Root Directory
**解决：**
1. Vercel 项目 Settings → General → Root Directory 设置为 `todo-web`
2. 确认 Build Command: `npm run build`，Output Directory: `dist`

---

## 问题 18：Vercel 构建 TypeScript 错误 - JSX 未启用

**现象：**
```
error TS6142: Module './components/TodoInput' was resolved to '...', but '--jsx' is not set.
error TS17004: Cannot use JSX unless the '--jsx' flag is provided.
```
**原因：** `tsconfig.json` 缺少 `jsx` 配置
**解决：** 在 `todo-web/tsconfig.json` 的 `compilerOptions` 中添加：
```json
{
  "compilerOptions": {
    "jsx": "react-jsx",
    "allowJs": true,
    "esModuleInterop": true
  }
}
```

---

## 问题 19：Vercel 构建 TypeScript 错误 - 未使用的导入

**现象：**
```
error TS6133: 'TodoResponse' is declared but its value is never read.
```
**解决：** 移除未使用的导入
```typescript
// 错误
import { todosApi, type TodoResponse, type TodoChange } from './utils/api';
// 正确
import { todosApi, type TodoChange } from './utils/api';
```

---

## 问题 20：Web 端登录 Failed to fetch - 后端未启动

**现象：** 登录时显示 "Failed to fetch"，控制台显示 CORS 错误
**原因：** Railway 后端服务未正常启动（见问题 21）
**解决：** 先修复 Railway 部署问题，后端启动后 CORS 会自动生效

---

## 问题 21：Railway 后端启动失败 - npm: command not found

**现象：**
```
start.sh: line 3: npm: command not found
start.sh: line 4: npm: command not found
Application failed to respond
```
**原因：** Railway 使用了 start.sh 脚本启动，但容器中没有 Node/npm 环境
**解决：**
1. 删除根目录的 `start.sh`（或从 Git 移除）
2. 在 Railway 服务 Settings 中配置：
   - **Root Directory**: `todo-api`
   - **Build Command**: `npm install && npm run build`
   - **Start Command**: `node dist/main.js`
3. 点击 "Apply Changes" 触发重新部署

**Railway 配置文件（推荐）：**
```toml
# railway.toml（放在项目根目录）
[build]
builder = "NIXPACKS"

[deploy]
startCommand = "node todo-api/dist/main.js"
```

---

## 问题 22：Android APK 运行红屏 - Unable to load script

**现象：** 安装 APK 后打开显示红屏 "Unable to load script"
**原因：** APK 中没有包含 JS Bundle，运行时需要从 Metro 服务器加载
**解决：** 在 GitHub Actions 中手动打包 JS Bundle：
```yaml
- name: Build APK
  run: |
    mkdir -p android/app/src/main/assets
    npx react-native bundle --platform android --dev false --entry-file index.ts --bundle-output android/app/src/main/assets/index.android.bundle --assets-dest android/app/src/main/res
    cd android && ./gradlew assembleDebug
```

---

## 问题 23：后端 CORS 配置

**现象：** 跨域请求被拦截
**原因：** CORS 配置只允许 localhost，生产环境需要允许所有来源
**解决：** 在 `todo-api/src/main.ts` 中配置：
```typescript
app.enableCors({
  origin: true, // 允许所有来源
  methods: 'GET,HEAD,PUT,PATCH,POST,DELETE,OPTIONS',
  credentials: true,
  allowedHeaders: 'Content-Type, Accept, Authorization',
});
```

---

## 二、关键配置检查清单

### 环境变量
- [ ] `todo-api/.env` 存在且包含 `DATABASE_URL`
- [ ] `DATABASE_URL` 格式正确：`postgresql://user:password@host:port/db`
- [ ] `JWT_SECRET` 已设置

### 数据库
- [ ] PostgreSQL 容器运行中：`docker ps` 看到 `todo-postgres`
- [ ] Prisma 迁移已执行：`npx prisma migrate dev`
- [ ] Prisma Client 已生成：`npx prisma generate`

### 后端服务
- [ ] 端口 3000 监听中：`netstat -ano | findstr "3000"`
- [ ] CORS 配置包含前端端口
- [ ] 全局异常过滤器已注册

### 前端服务
- [ ] 端口 5173 监听中：`netstat -ano | findstr "5173"`
- [ ] `api.ts` 中 `API_URL` 正确（默认 `http://localhost:3000`）
- [ ] 响应格式兼容逻辑已添加

---

## 三、调试命令速查

### 启动服务
```powershell
# 后端
cd todo-api
npm run start:dev

# Web 前端
cd todo-web
npm run dev

# Android/Expo 移动端
cd todo-mobile
npx expo start --web
```

### 检查端口
```powershell
netstat -ano | findstr "3000"  # 后端
netstat -ano | findstr "5173"  # Web 前端
netstat -ano | findstr "8083"  # Expo Web 预览
netstat -ano | findstr "5432"  # PostgreSQL
```

### 检查容器
```powershell
docker ps                              # 运行中的容器
docker ps --filter "name=todo-postgres"  # PostgreSQL
```

### 测试 API（PowerShell）
```powershell
# 健康检查
Invoke-WebRequest -Uri "http://localhost:3000/" -UseBasicParsing

# 注册（需要先创建 .ps1 脚本避免 JSON 转义问题）
```

### 11. M5 部署阶段问题清单 (2026-02-20)

- **Railway 后端 502 Bad Gateway**
    - **现象**：后端部署成功但公网访问返回 502。
    - **原因**：
        1. Postgres 服务的 `DATABASE_URL` 变量被错误覆盖为字符串 `"DATABASE_URL"`，导致变量引用链断裂。
        2. NestJS 默认监听 `localhost`，在 Docker 容器中必须监听 `0.0.0.0`。
    - **解决**：清理 Postgres 变量污染，后端 `DATABASE_URL` 改为引用 `${{Postgres.DATABASE_PUBLIC_URL}}`；修改 `main.ts` 监听 `0.0.0.0`。

- **Prisma 报错 "The table public.User does not exist"**
    - **现象**：后端启动成功但注册请求报错表不存在。
    - **原因**：数据库是空的，Prisma Schema 未同步。本地网络无法连接 Railway TCP Proxy 导致 `npx prisma db push` 失败。
    - **解决**：在 `Dockerfile` 的 `CMD` 中添加 `npx prisma db push --accept-data-loss`，利用 Railway 内网环境在启动时自动同步。

- **Dockerfile CMD 不执行 (Start Command 冲突)**
    - **现象**：修改了 Dockerfile 的 CMD 但日志里没看到执行。
    - **原因**：Railway Web 界面设置了 **Start Command**，它会覆盖 Dockerfile 的 `CMD`。
    - **解决**：在 Railway Settings 中清空 Start Command，或者显式设置为包含同步逻辑的 `sh -c` 命令。

---
```powershell
# 杀掉 node 进程
taskkill /F /IM node.exe

# 重新启动
cd todo-api && npm run start:dev
cd todo-web && npm run dev
```

---

## 四、大模型 vibe coding 注意事项

1. **Windows 环境特殊处理**
   - PowerShell 的 `curl` 是别名，建议使用完整路径或 `.ps1` 脚本
   - Docker Desktop 需要 WSL2，确保用户已安装并启用

2. **Prisma 版本选择**
   - 生产项目建议锁定 v5，避免 v7 的配置变更导致兼容问题

3. **前后端响应格式一致性**
   - 后端使用统一响应 `{ data, error }` 时，前端需要兼容直接返回的情况
   - 建议在 `api.ts` 中添加兼容逻辑

4. **CORS 配置**
   - 开发环境确保 CORS origin 包含前端端口
   - 生产环境需要配置具体的域名

5. **环境变量管理**
   - `.env` 文件不提交到 Git
   - 数据库连接串包含敏感信息，确保安全

6. **热更新问题**
   - 如果前端代码变更后无响应，尝试重启前端服务
   - 如果后端请求无响应，检查后端是否正常运行

---

## 五、常见错误速查

| 错误 | 可能原因 | 解决思路 |
|------|----------|----------|
| `ERR_CONNECTION_REFUSED` | 服务未启动 | 检查端口监听，重启服务 |
| CORS 错误 | CORS 配置不正确 | 检查后端 CORS 配置 |
| 400 验证错误 | DTO 缺少 `@IsOptional()` | 添加装饰器 |
| 登录无响应 | 后端服务挂了 | 重启后端 |
| Prisma 生成失败 | 版本不兼容 | 降级到 v5 |
| Docker 启动失败 | WSL 版本旧 | 执行 `wsl --update` |

---

## 12. M5 Android APK 构建失败排障记录（2026-02-21）

### 背景

目标是在 GitHub Actions 中构建可离线运行的 Debug APK（包含 JS Bundle）。构建使用 Expo prebuild 生成原生工程，并执行 Gradle `assembleDebug`。

### 问题 1：Actions 日志过长导致网页卡死，无法快速定位首个错误

**现象**：Gradle 开启 `--info` 后日志非常长，在 GitHub 网页端翻阅容易卡死，导致“看起来像一直在编译”。

**解决策略（可复刻）**：
- 优先抓“首个真实错误块”，而不是盯着最后一行。
- 关键检索词（从上到下找第一次出现处）：
  - `FAILURE: Build failed with an exception.`
  - `* What went wrong:`
  - `Execution failed for task` 
  - `e: `（Kotlin 编译错误常用前缀）
  - `error: `（Java/Javac 错误常用前缀）
- 如果网页端卡死：下载 Logs ZIP 或保存 step 日志为本地 txt，用文本搜索定位。

### 问题 2：误判为 Reanimated 不兼容，但实际首个阻塞点是 Gesture Handler Kotlin 编译

**现象**：构建阶段多次停在原生编译，看起来像 `react-native-reanimated` 相关，但真正导致构建失败的首个任务是：
```
Execution failed for task ':react-native-gesture-handler:compileDebugKotlin'.
```

**关键证据（Kotlin 报错）**：
```
Class 'RNGestureHandlerPackage' is not abstract and does not implement abstract members
'getViewManagerNames' overrides nothing
'getViewManagers' overrides nothing
'createViewManager' overrides nothing
```

**根因**：
- 项目使用 `react-native@0.81.5`（Expo 54）。
- `react-native-gesture-handler@2.20.2` 与当前 RN 的 `ReactPackage`/ViewManager API 签名不兼容，导致 `RNGestureHandlerPackage.kt` override 失败。

**修复**：升级 `react-native-gesture-handler` 到新版本（例如 `2.30.0`），让其适配 RN 0.81.x。

### 问题 3：Reanimated 版本冲突/疑似未生效（需要让 CI 自证依赖版本）

**现象**：日志中出现“像是旧版本 Reanimated 报错”的信息时，无法确认 CI 实际安装的版本是否与本地一致。

**根因**：
- workflow 使用 `npm install` 时，可能出现依赖树漂移/缓存导致与 lockfile 不一致。

**修复策略（让 CI 可自证）**：
- 将 Actions 的依赖安装改为 `npm ci`（严格按 `package-lock.json`）。
- 在构建前打印真实依赖版本：
  - `npm ls react-native --depth=0`
  - `npm ls react-native-reanimated --depth=0`
  - `npm ls react-native-gesture-handler --depth=0`
  - `node -p "require('react-native/package.json').version"` 等

**结果**：在日志中明确看到版本：
- `react-native@0.81.5`
- `react-native-reanimated@4.2.2`
- `react-native-gesture-handler@2.20.2`（随后升级解决）

### 可复刻的最小排障流程（建议以后按这个顺序）

1. 在 CI 日志中定位第一次出现的 `FAILURE` 块。
2. 看第一条 `Execution failed for task ...` 指向哪个模块。
3. 如果是 Kotlin 编译失败，优先找 `e:` 行并定位具体 `.kt` 文件与签名错误。
4. 通过 `npm ls <pkg> --depth=0` 和 `node -p require(...).version` 固定“真实版本”，避免凭感觉升级。
5. 不要用 `npm install` 让 CI 自己决定依赖树；使用 `npm ci`。


*本文档随项目迭代更新，建议每次遇到新问题后补充到对应章节。*
