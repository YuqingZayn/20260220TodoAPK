# 开发任务清单（M1-M4）  
**项目：多设备同步待办事项（Web + Android）**  
**技术栈：** React+TS+Vite / Kotlin+Compose / NestJS+TS+Postgres / 邮箱+密码登录  
**最后更新：** 2026-02-19

---

## 里程碑概览

| 阶段 | 目标 | 关键交付 |
|---|---|---|
| M1 | Web 版基础 CRUD + 本地存储 | 可用的待办页面（离线可用） |
| M2 | 邮箱登录 + 后端服务 | 能注册/登录，数据走云端 |
| M3 | 多设备同步（增量/冲突/软删除） | Web 与 Android 数据一致 |
| M4 | Android 端接入 + 离线同步稳定性 | 手机端完整可用 |

---

## M1：Web 版基础 CRUD + 本地存储（先把待办做顺手）

### M1-WEB-01 项目初始化
- **内容**：用 Vite 创建 React+TS 项目，安装 Tailwind CSS
- **产出**：`npm run dev` 能跑，页面可访问
- **验收点**：浏览器打开 `http://localhost:5173` 看到默认页面

### M1-WEB-02 项目结构搭建
- **内容**：建 `components/`、`types/`、`utils/` 目录
- **产出**：目录结构清晰，文件路径引用无报错
- **验收点**：`src/components/TodoItem.tsx` 等文件存在

### M1-WEB-03 Todo 类型定义
- **内容**：`src/types/todo.ts` 定义 `Todo` 接口（id/title/completed/createdAt/updatedAt/deletedAt?）
- **注意**：字段名必须与后端 `prisma/schema.prisma` 严格一致（统一使用小驼峰）。
- **产出**：类型文件，其他组件可引用
- **验收点**：TS 无类型报错

### M1-WEB-04 本地存储工具
- **内容**：`src/utils/storage.ts` 实现 `loadTodos`/`saveTodos`（LocalStorage）
- **产出**：可读写 `localStorage` 的工具函数
- **验收点**：控制台手动 `localStorage.setItem('todos','[]')`，刷新不报错

### M1-WEB-05 TodoInput 组件
- **内容**：输入框 + 回车/按钮新增，非空校验，成功清空
- **产出**：`TodoInput.tsx`
- **验收点**：连续新增 5 条，空字符串不新增

### M1-WEB-06 TodoItem 组件
- **内容**：checkbox 完成切换、点击内联编辑、删除按钮
- **产出**：`TodoItem.tsx`
- **验收点**：勾选/取消完成；点击编辑，回车保存，Esc 取消；删除

### M1-WEB-07 TodoList 组件
- **内容**：列表渲染，空状态提示
- **产出**：`TodoList.tsx`
- **验收点**：列表正确渲染；空列表显示提示

### M1-WEB-08 主页面（App.tsx）
- **内容**：状态管理、CRUD 事件处理、调用 storage 保存
- **产出**：`App.tsx`
- **验收点**：完整 CRUD 流程；刷新页面数据不丢

### M1-WEB-09 UI 美化（可选 P1）
- **内容**：卡片布局、阴影、过渡动效
- **产出**：更现代的 UI
- **验收点**：视觉符合 PRD 设计规范

### M1-WEB-10 筛选与排序（可选 P1）
- **内容**：全部/未完成/已完成；最新优先/最早优先
- **产出**：筛选控件、排序逻辑
- **验收点**：切换筛选/排序，列表正确变化

---

## M2：邮箱登录 + 后端服务（能登录，有账号）

### M2-ENV-01 环境配置
- **内容**：创建 `.env` 文件存储数据库连接串、JWT 密钥；前端创建 `.env.development` 存储 API 地址。
- **产出**：配置文件，代码中引用环境变量
- **验收点**：代码中不出现明文密码或硬编码的 IP 地址。

### M2-BE-01 后端项目初始化
- **内容**：NestJS + TypeScript 项目，安装必要依赖（JWT、Passport、Prisma、bcrypt）
- **产出**：`npm run start:dev` 能跑
- **验收点**：`GET /` 返回 `Hello World`

### M2-BE-02 数据库与 Prisma Schema
- **内容**：PostgreSQL + Prisma，定义 `User` 与 `Todo` 表，软删除字段
- **产出**：`prisma/schema.prisma`，迁移完成
- **验收点**：`npx prisma studio` 能看到表结构

### M2-BE-03 JWT 认证模块
- **内容**：注册/登录接口，密码 bcrypt 存储，JWT 签发与验证
- **产出**：`auth` 模块，`/auth/register`、`/auth/login`
- **验收点**：注册后密码非明文；登录返回 `access_token`

### M2-BE-04 Todo CRUD 接口（带认证）
- **内容**：`GET/POST/PUT/DELETE /todos`，按 `userId` 隔离，软删除
- **产出**：`todos` 模块，接口完整
- **验收点**：不带 token 返回 401；A 用户看不到 B 用户数据

### M2-BE-05 错误处理与统一响应格式
- **内容**：全局异常过滤器，统一返回 `{ data, error }`
- **产出**：更友好的 API 响应
- **验收点**：异常返回结构一致，前端可统一处理

### M2-WEB-01 请求封装（带 token）
- **内容**：`src/utils/api.ts`，自动带 `Authorization: Bearer <token>`
- **注意**：请求时需处理 Loading 状态，并在失败时通过 Toast/弹窗提示用户。
- **产出**：统一的请求工具
- **验收点**：登录后请求 `/todos` 成功

### M2-WEB-02 登录页面/弹窗
- **内容**：邮箱/密码输入、登录/注册按钮、退出登录
- **产出**：登录 UI + 表单校验
- **验收点**：登录成功后跳转/显示登录态；退出后清 token

### M2-WEB-03 替换本地存储为远程 API
- **内容**：CRUD 改为调用后端接口，去掉 LocalStorage
- **产出**：所有操作走云端
- **验收点**：刷新页面数据不丢（从云端拉取）

### M2-WEB-04 登录状态管理
- **内容**：`localStorage` 存 token，401 自动清 token 并跳登录
- **产出**：完整的登录态管理
- **验收点**：token 过期后自动跳登录页

---

## M2 修复记录（开发中发现的问题）

### 修复 1：Prisma 版本降级
- **问题**：`npx prisma generate` 报错，v7 要求 `prisma.config.ts`
- **解决**：降级到 v5
```powershell
npm install prisma@5 @prisma/client@5 --save
```

### 修复 2：后端响应格式兼容
- **问题**：后端 Auth 模块直接返回 `{ access_token }`，未包装 `{ data }`
- **解决**：前端 `api.ts` 兼容两种格式
```typescript
return { data: data.data !== undefined ? data.data : data };
```

### 修复 3：ValidationPipe 可选字段验证
- **问题**：注册时 `name` 字段报 400 错误
- **解决**：添加 `@IsOptional()` 装饰器
```typescript
@IsOptional()
@IsString()
name?: string;
```

### 修复 4：后端未返回统一响应格式
- **问题**：后端直接返回业务对象，未包装 `{ data, error }`
- **解决**：添加 `GlobalExceptionFilter`，并在成功时手动包装
```typescript
// 全局异常过滤器已实现 { data, error }
// 成功响应需要在 controller 返回时包装
```

### 修复 5：数据库连接配置
- **问题**：`.env` 中 DATABASE_URL 与 docker-compose 凭据不匹配
- **解决**：更新为 `postgresql://todo_user:todo_password@localhost:5432/todo_db`

---

## M2 补充遗漏项

### 补充 1：PrismaService 注册
- **内容**：创建 `src/prisma.service.ts`，在 AppModule 中注册
- **产出**：数据库连接生命周期管理
- **验收点**：`npm run start:dev` 启动无报错

### 补充 2：Auth/Todos 模块注入 PrismaService
- **内容**：在 AuthModule 和 TodosModule 中导入 PrismaService
- **产出**：Service 可直接使用 Prisma Client
- **验收点**：登录/CRUD 操作正常

### 补充 3：全局异常过滤器
- **内容**：`src/filters/global-exception.filter.ts` 实现 `{ data, error }` 格式
- **产出**：统一的错误响应
- **验收点**：任何异常都返回统一格式

### 补充 4：前端 Loading 状态处理
- **内容**：LoginModal 中 `loading` 状态控制按钮文字
- **产出**：用户知道请求在进行中
- **验收点**：点击登录后按钮显示"处理中..."

### 补充 5：前端错误捕获
- **内容**：LoginModal 添加 try-catch 捕获请求异常
- **产出**：网络错误时显示友好提示
- **验收点**：后端不可用时显示错误信息而非无响应

---

## M3：多设备同步（增量/冲突/软删除）——真正实现多设备一致

### M3-BE-01 增量同步接口
- **内容**：支持 `since` 参数拉取自上次同步以来的变更（新增/更新/软删除）
- **产出**：`GET /todos/sync?since=xxx`，返回变更列表
- **验收点**：客户端能只拉取增量数据

### M3-BE-02 冲突策略（LWW）
- **内容**：用 `updatedAt`（或 version）实现“最后写入优先”
- **产出**：更新接口冲突处理逻辑
- **验收点**：并发编辑后最终为最后一次更新的内容

### M3-BE-03 软删除与删除不复活
- **内容**：删除只设置 `deletedAt`，列表接口过滤已删除
- **产出**：删除不物理移除
- **验收点**：A 删除后，B 离线再上线不会复活

### M3-BE-04 同步错误码与日志
- **内容**：明确错误码（鉴权失败/参数错误/服务器异常），记录冲突事件
- **产出**：错误码定义 + 基础日志
- **验收点**：前端能根据错误码提示用户

### M3-WEB-01 本地优先 + 后台同步
- **内容**：所有 CRUD 先更新本地 UI，再异步调用同步接口
- **产出**：离线可用，联网后补同步
- **验收点**：断网时操作不卡顿，联网后自动同步

### M3-WEB-02 同步状态 UI
- **内容**：显示“同步中/已同步/失败/离线”；提供“立即同步”按钮
- **产出**：状态展示组件
- **验收点**：断网显示离线；恢复网络后自动变为已同步

### M3-WEB-03 登录后“默认合并”
- **内容**：登录成功后，把本地游客 todo 上传到云端，再拉取云端合并
- **产出**：合并逻辑
- **验收点**：游客数据登录后自动合并；换设备登录能看到

### M3-WEB-04 同步触发时机
- **内容**：启动/登录成功/网络恢复/用户操作后触发同步
- **产出**：触发逻辑封装
- **验收点**：关掉网页再打开，能自动拉取到最新数据

---

## M4：Android 端接入 + 离线同步稳定性（手机上也好用）

### M4-AND-01 Android 项目初始化
- **内容**：Kotlin + Jetpack Compose 项目，依赖 Room、Retrofit、OkHttp
- **产出**：可运行的 Android 项目
- **验收点**：App 能启动，显示空白页面

### M4-AND-02 本地数据库（Room）
- **内容**：`Todo` 实体、DAO、数据库实例，支持软删除
- **产出**：本地存储层
- **验收点**：插入/查询/更新/删除，重启 App 数据不丢

### M4-AND-03 UI 组件（Composable）
- **内容**：TodoInput、TodoItem、TodoList，与 Web 体验一致
- **产出**：UI 界面
- **验收点**：本地 CRUD 跑通（不连后端）

### M4-AND-04 网络层（Retrofit）
- **内容**：定义 API 接口（注册/登录/CRUD/同步），调用后端
- **注意**：若后端为 http 协议（本地调试），需在 `AndroidManifest.xml` 配置 `android:networkSecurityConfig`。
- **产出**：网络请求封装
- **验收点**：能调用后端 `/todos` 接口

### M4-AND-05 登录与 Token 管理
- **内容**：邮箱密码登录、token 本地保存、请求自动带 token
- **产出**：登录态管理
- **验收点**：登录后能访问 todo 接口；退出后清 token

### M4-AND-06 同步模块（同 Web 规则）
- **内容**：本地优先 + 后台同步；网络恢复触发同步；LWW 冲突策略
- **产出**：同步服务
- **验收点**：安卓新增，Web 能看到；Web 修改，安卓能看到

### M4-AND-07 离线队列与失败重试
- **内容**：同步失败存队列，定时/网络恢复重试
- **产出**：可靠性保障
- **验收点**：弱网下最终能同步成功；不无限报错

---

## M5：部署上线（公网可访问）

### M5-BE-01 后端云端部署
- **内容**：将 NestJS 后端部署到云服务器（或 Railway/Render/阿里云）
- **产出**：公网可访问的 API 服务（如 `https://todo-api.example.com`）
- **验收点**：`curl` 测试登录接口返回成功

### M5-BE-02 数据库云端化
- **内容**：将 PostgreSQL 迁移到云数据库（如 Railway、Supabase、阿里云 RDS）
- **产出**：数据持久化在云端，不依赖本地 Docker
- **验收点**：重启后端服务数据不丢失

### M5-WEB-01 Web 静态部署
- **内容**：将 Vite 构建的静态页面部署到 CDN（如 Vercel、Netlify）
- **产出**：公网可访问的 Web 站点（如 `https://todo.example.com`）
- **验收点**：浏览器打开网址能正常登录和操作

### M5-AND-01 Android 打包
- **内容**：使用 Expo 或 Capacitor 打包 APK
- **产出**：可安装的 `.apk` 文件
- **验收点**： APK 安装到手机后能正常登录和同步

### M5-AND-02 配置公网 API 地址
- **内容**：修改移动端 API 地址指向云端后端
- **产出**：手机 App 连接云端服务
- **验收点**：手机与 Web 使用同一后端，数据互通

---

## 横向任务（贯穿全程）

### QA-01 手工测试用例
- **内容**：编写“操作步骤 + 预期结果”的测试表
- **产出**：测试文档
- **验收点**：覆盖新增/编辑/完成/删除/离线/登录合并/删除不复活

### QA-02 联调脚本/假数据
- **内容**：快速造 100 条 todo 的方法（脚本或隐藏按钮）
- **产出**：数据构造工具
- **验收点**：可快速检查性能与同步速度

---

## 验收标准（最终检查清单）

- **跨设备新增一致**：安卓新增，Web 能看到；Web 新增，安卓能看到
- **跨设备编辑一致**：任一端改标题/完成状态，另一端能同步到
- **离线不丢**：断网操作成功保存在本地；联网后自动同步到另一端
- **删除不复活**：A 删了，B 离线也不会把它同步回来
- **登录合并**：游客数据登录后自动合并；换设备登录能看到
- **性能**：首屏 < 2s；交互 < 100ms；1000 条不卡顿

---

## 实现状态（2026-02-20）

### M1 Web 版基础 CRUD ✅
- [x] 待办列表展示
- [x] 新增待办
- [x] 编辑待办
- [x] 完成/未完成切换
- [x] 删除待办

### M2 云端服务 + 邮箱登录 ✅
- [x] Docker PostgreSQL 搭建
- [x] Prisma 集成
- [x] JWT 认证
- [x] 后端 CRUD API
- [x] 前端登录界面
- [x] 记住账号/密码功能
- [x] 邮箱验证码找回密码
- [x] 统一响应格式 { data, error }

### M3 多设备同步 ✅
- [x] 增量同步接口 GET /todos/sync?since
- [x] LWW 冲突策略
- [x] 软删除（删除不复活）
- [x] 同步错误码
- [x] 前端同步状态 UI
- [x] 同步触发时机（启动/登录/网络恢复）

### M4 Android 端接入 🚧
- [x] Expo 项目初始化
- [x] 登录/注册界面
- [x] 待办列表界面
- [x] 优先级功能
- [x] 筛选功能
- [ ] 离线队列与失败重试（待实现）

### M5 公网部署 ✅
- [x] 后端 Railway 部署 (Dockerfile, 0.0.0.0, OpenSSL)
- [x] 数据库 Railway PostgreSQL (修复变量污染)
- [x] Web 前端 Vercel 部署 (tsconfig.json 修复)
- [x] Android APK GitHub Actions 构建 (修复 JS Bundle 缺失)
- [x] 公网 API 地址配置 (Web/Android → Railway)
- [x] 数据库自动同步 (CMD 运行 `prisma db push`)
- [ ] 验证 Web 注册/登录功能
- [ ] 验证 Android APK 联网功能

---

## M5 部署配置要点（供大模型参考）

### Railway 后端配置
```
Root Directory: todo-api
Build Command: npm install && npm run build
Start Command: node dist/main.js
```

### Vercel Web 配置
```
Root Directory: todo-web
Build Command: npm run build
Output Directory: dist
```

### GitHub Actions Android 构建
需要在 workflow 中手动打包 JS Bundle，否则 APK 会红屏报错 "Unable to load script"

### 公网地址
- 后端 API: https://20260220todoapk-production.up.railway.app
- Web 前端: https://20260220-todo-apk.vercel.app

- 本文档为“可执行任务清单”，每一条都可以独立完成并验收。
- 新手建议按顺序执行，遇到报错可对照“验收点”排查。
- 如需调整技术栈或需求，请同步更新本文档。

---
